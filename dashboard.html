<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard — Boblox</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <main class="center">
    <h1 id="title">Dashboard</h1>
    <div id="nav">
      <button onclick="location.href='/servers.html'">Servers</button>
      <button onclick="location.href='/chat.html'">Chat</button>
      <button onclick="location.href='/games.html'">Games</button>
      <button id="logout">Logout</button>
    </div>
    <div id="profile"></div>
    <div id="onboard" style="margin-top:18px"></div>
  </main>
  <script>
    // API base detection (same origin or fallbacks)
    const FALLBACKS = ['https://quick-maps-write.loca.lt'];
    let API_BASE = window.location.origin;
    async function detectBase(){
      const tryHost = async (base)=>{
        try{ const ctrl=new AbortController(); const id=setTimeout(()=>ctrl.abort(),2000);
          const r = await fetch(new URL('/health',base).toString(),{signal:ctrl.signal}); clearTimeout(id); return r && r.ok; }catch(e){return false}
      };
      if(await tryHost(window.location.origin)){ API_BASE = window.location.origin; return; }
      for(const f of FALLBACKS){ if(await tryHost(f)){ API_BASE = f; return; } }
      API_BASE = window.location.origin; // fallback
    }

    async function get(url){ return fetch((API_BASE===window.location.origin?url:API_BASE+url),{headers:{'Authorization':'Bearer '+localStorage.getItem('token')}}).then(r=>r.json()); }
    async function load(){ await detectBase(); const me=await get('/api/me'); if(me.error){ alert('Please login'); location.href='/auth.html'; return; }
      document.getElementById('profile').innerText=JSON.stringify(me);
      // fetch servers and games to decide whether to show onboarding
      const sv = await get('/api/servers'); const gv = await get('/api/games');
      const ob = document.getElementById('onboard');
      if((sv.servers && sv.servers.length===0) || (gv.games && gv.games.length===0)){
        ob.innerHTML = `<div style="padding:12px;background:rgba(0,0,0,0.12);border-radius:8px;text-align:left">
          <h3>Complete your setup</h3>
          <p>Create a server, or a game to get started quickly.</p>
          <p><a href="/onboarding.html" class="cta">Open onboarding</a></p>
        </div>`;
      } else {
        ob.innerHTML = `<div style="padding:12px;background:rgba(0,0,0,0.06);border-radius:8px;text-align:left">
          <h3>Your quick links</h3>
          <p><a href="/servers.html">Servers</a> · <a href="/chat.html">Chat</a> · <a href="/games.html">Games</a></p>
        </div>`;
      }
    }
    document.getElementById('logout').onclick=()=>{ localStorage.removeItem('token'); location.href='/auth.html'; };
    load();
  </script>
</body>
</html>