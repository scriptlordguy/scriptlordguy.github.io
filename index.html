<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Boblox — Coming Soon</title>
    <meta name="description" content="Boblox — Coming Soon" />
    <link rel="icon" href="/assets/favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="/styles.css">
  </head>
  <body>
    <main class="center">
      <img src="/assets/favicon.svg" alt="logo" class="logo" />
      <h1>Boblox</h1>
      <p class="tag">Play now — sign in or create an account</p>
      <p style="margin-top:12px"><a class="cta" href="/play.html">Play public demos (no account)</a></p>

      <div id="forms" style="max-width:420px;width:100%">
        <div style="display:flex;gap:12px">
          <button id="showLogin" class="cta" style="background:#0b84ff">Login</button>
          <button id="showSignup" class="cta" style="background:#10b981">Sign up</button>
        </div>

        <div id="loginForm" style="display:none;margin-top:12px">
          <input id="li_email" placeholder="Email" style="width:100%"><br>
          <input id="li_pass" type="password" placeholder="Password" style="width:100%;margin-top:8px"><br>
          <button id="loginBtn" class="cta" style="margin-top:10px">Login</button>
        </div>

        <div id="signupForm" style="display:none;margin-top:12px">
          <input id="su_username" placeholder="Username" style="width:100%"><br>
          <input id="su_email" placeholder="Email" style="width:100%;margin-top:8px"><br>
          <input id="su_phone" placeholder="Phone" style="width:100%;margin-top:8px"><br>
          <input id="su_pass" type="password" placeholder="Password" style="width:100%;margin-top:8px"><br>
          <button id="signupBtn" class="cta" style="margin-top:10px">Create account</button>
        </div>

        <p class="muted" id="status">Detecting backend...</p>
      </div>
    </main>

    <script>
      // Detect API base (same-origin only); no public tunnel fallback configured
      const fallbackHosts = [];
      let API_BASE = window.location.origin; // default

      async function checkHost(base){
        try{
          const ctrl=new AbortController(); const id=setTimeout(()=>ctrl.abort(),2000);
          const r=await fetch(new URL('/health',base).toString(),{signal:ctrl.signal}); clearTimeout(id);
          return r && r.ok;
        }catch(e){return false}
      }

      (async ()=>{
        const statusEl=document.getElementById('status');
        if(await checkHost(window.location.origin)){
          statusEl.textContent='Backend available (same origin).'; API_BASE=window.location.origin; return;
        }
        for(const h of fallbackHosts){ if(await checkHost(h)){ statusEl.textContent='Backend available at ' + h; API_BASE=h; return; } }
        statusEl.textContent='No backend detected — the site will still allow account creation if you host the backend or use the Play button.';
      })();

      function jsonPost(url,body){ return fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}).then(r=>r.json()); }

      document.getElementById('showLogin').onclick=()=>{ document.getElementById('loginForm').style.display='block'; document.getElementById('signupForm').style.display='none'; };
      document.getElementById('showSignup').onclick=()=>{ document.getElementById('signupForm').style.display='block'; document.getElementById('loginForm').style.display='none'; };

      document.getElementById('signupBtn').onclick=async ()=>{
        const username=document.getElementById('su_username').value; const email=document.getElementById('su_email').value; const phone=document.getElementById('su_phone').value; const pass=document.getElementById('su_pass').value;
        const res = await jsonPost(API_BASE + '/api/signup',{username,email,password:pass,phone});
        if(res.token){ localStorage.setItem('token',res.token); window.location.href = (API_BASE===window.location.origin?'/dashboard.html':API_BASE + '/dashboard.html'); }
        else alert(res.error||'Signup failed');
      };

      document.getElementById('loginBtn').onclick=async ()=>{
        const email=document.getElementById('li_email').value; const pass=document.getElementById('li_pass').value;
        const res = await jsonPost(API_BASE + '/api/login',{email,password:pass});
        if(res.token){ localStorage.setItem('token',res.token); window.location.href = (API_BASE===window.location.origin?'/dashboard.html':API_BASE + '/dashboard.html'); }
        else alert(res.error||'Login failed');
      };

      // Show login by default
      document.getElementById('showLogin').click();
    </script>
  </body>
</html>